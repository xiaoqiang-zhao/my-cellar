<!DOCTYPE html>
<html>
<head lang="zh-cn">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>chrome exetentions v3 å®æˆ˜ - å°å¼ºèµµçš„ä¸ªäººç«™ç‚¹</title>
    <script>
        // ç”¨æˆ·é€šè¿‡æœç´¢å¼•æ“åˆ°æ–‡ç« è¯¦æƒ…é¡µæ—¶ï¼Œè·³åˆ°é¦–é¡µå¹¶è¿›è¡Œå“ˆå¸Œè·¯ç”±
        var href = window.location.href.replace(/[^:|\/]\//,function (matchStr){
            return matchStr + 'index.html#!';
        });
        window.location.href = href.replace('/main.html', '');
    </script>
</head>
<body>
<header>
    <h1> å°å¼ºèµµçš„ä¸ªäººç«™ç‚¹ </h1>
    <h2> ç²¾è¿›è‡ªå·±ï¼ŒæœåŠ¡ä»–äºº </h2>
</header>
<div>
    <h1 id="header-1">chrome exetentions v3 å®æˆ˜</h1>
<h2 id="header-1-1">popup.js</h2>
<h3 id="header-1-1-1">åŸºæœ¬æµç¨‹</h3>
<p>popup.js æ²¡ç‚¹å¼€ä¸€æ¬¡å°çª—éƒ½ä¼šè¢«æ‰§è¡Œä¸€æ¬¡ã€‚</p>
<pre><code class="lang-js">// éªŒè¯æ¯æ¬¡æ‰“å¼€ popup é¡µé¢éƒ½æ˜¯é‡æ–°åŠ è½½çš„
chrome.storage.sync.get(&#39;total&#39;, ({
    total
}) =&gt; {
    total++;
    document.getElementById(&#39;total&#39;).innerHTML = total.toString();
    chrome.storage.sync.set({
        total
    });
});
</code></pre>
<p>popup.html ä¸­å¦‚æœæœ‰ inputï¼Œå¡«å†™å®Œä¹‹åå…³é—­å°çª—ï¼Œå†æ‰“å¼€ä½ ä¼šå‘ç°å¡«å†™çš„å†…å®¹å·²ç»æ²¡æœ‰äº†ï¼Œå°±å’Œåˆ·æ–°äº†é¡µé¢ä¸€æ ·ã€‚</p>
<h3 id="header-1-1-2">ä½œç”¨åŸŸ</h3>
<p>åœ¨ popup ä¸­ç›´æ¥è·å– dom èŠ‚ç‚¹æ—¶ï¼Œä½œç”¨åŸŸæ˜¯ popup.htmlã€‚</p>
<pre><code class="lang-js">const btn = document.getElementById(&#39;btn&#39;);
</code></pre>
<p>å¯ä»¥ç»™æŒ‰é’®æ·»åŠ äº‹ä»¶:</p>
<pre><code class="lang-js">btn.addEventListener(&quot;click&quot;, async () =&gt; {
    // ...
});
</code></pre>
<p>ä½†æ˜¯ä¸èƒ½ç›´æ¥è®¿é—®æµè§ˆå™¨ä¸­çš„ç½‘ç«™ Domï¼Œä¸‹é¢æ˜¯ä¸€ç§çªç ´è¿™ä¸ªé™åˆ¶çš„æ–¹æ³•ã€‚</p>
<h3 id="header-1-1-3">æ“çºµç½‘é¡µä¸­çš„ Dom</h3>
<p>chrome extension æä¾›äº†æ–¹æ³•æ¥è·å– tabã€‚</p>
<pre><code class="lang-js">let [tab] = await chrome.tabs.query({
    active: true,
    currentWindow: true
});
</code></pre>
<p>æœ‰äº† tab å¯¹è±¡å°±å¯ä»¥é€šè¿‡ <code>executeScript</code> æ–¹æ³•çš„å›è°ƒæ¥æ“ä½œç½‘é¡µä¸­çš„ dom èŠ‚ç‚¹ã€‚</p>
<pre><code class="lang-js">chrome.scripting.executeScript({
    target: {
        tabId: tab.id
    },
    function() {
        // è¿™é‡Œå¯ä»¥è·å¾—æ¿€æ´»ç½‘é¡µçš„ Dom

        // è‡ªåŠ¨å¡«å†™ç”¨æˆ·åå’Œå¯†ç 
        const userName = document.getElementById(&#39;userName&#39;);
        userName.value = &#39;admin&#39;;
        const passWord = document.getElementById(&#39;passWord&#39;);
        passWord.value = &#39;123456&#39;;
    }
});
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•çš„æœ¬è´¨æ˜¯å°†å›è°ƒå‡½æ•°ä¸­çš„ä»£ç æ³¨å…¥åˆ°é¡µé¢ä¸­ï¼Œå’Œä¸‹é¢æåˆ°çš„ content scripts å…·æœ‰å¾ˆé«˜çš„ç›¸ä¼¼æ€§ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œçš„å›è°ƒå¹¶ä¸èƒ½è®¿é—®å¤–é¢å®šä¹‰çš„å‡½æ•°ï¼Œå› ä¸ºåœ¨åŸç†ä¸Š chrome extension å¯¹å„æ¨¡å—æ˜¯åˆ†è¿›ç¨‹æ‰§è¡Œçš„ï¼Œä»–ä»¬å¹¶ä¸å…±äº«ä½œç”¨åŸŸã€‚</p>
<h2 id="header-1-2">content script</h2>
<p>content script æ˜¯æ³¨å…¥åˆ°é¡µé¢ä¸­çš„ï¼Œåœ¨ç½‘é¡µåŠ è½½æ—¶æ‰§è¡Œã€‚å¯ä¸ºä¸åŒçš„ç½‘é¡µé…ç½®ä¸åŒçš„æ‰§è¡Œè„šæœ¬ï¼Œä¹Ÿå¯ä¸ºä¸€ç±»ç½‘ç«™é…ç½®é€šç”¨è„šæœ¬:</p>
<pre><code class="lang-js">&quot;content_scripts&quot;: [
    {
        &quot;matches&quot;: [
            &quot;http://127.0.0.1:8898/*&quot;
        ],
        &quot;run_at&quot;: &quot;document_end&quot;,
        &quot;js&quot;: [&quot;contentScriptLocalDebug.js&quot;]
    },
    {
        &quot;matches&quot;: [
            &quot;https://zhihu.com/*&quot;
        ],
        &quot;run_at&quot;: &quot;document_start&quot;,
        &quot;js&quot;: [
            &quot;jquery-3.6.0.min.js&quot;,
            &quot;contentScriptZhihu.js&quot;
        ]
    }
]
</code></pre>
<p>ä¸ºäº†ç¡®ä¿ dom å·²ç»åŠ è½½å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»£ç æ”¾å…¥å¯¹ DOMContentLoaded äº‹ä»¶çš„ç›‘å¬å›è°ƒä¸­ã€‚</p>
<pre><code class="lang-js">document.addEventListener(&#39;DOMContentLoaded&#39;, () =&gt; {
    // ...
});
</code></pre>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ“çºµ dom å±æ€§ã€‚</p>
<pre><code class="lang-js">// contentScriptLocalDebug.js
// æ”¹å˜èƒŒæ™¯é¢œè‰²
document.body.style.backgroundColor = &#39;green&#39;;
// ç›´æ¥è°ƒå‡ºç™»é™†æ¡†ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹å‡»
document.getElementById(&#39;login-box&#39;).style.display = &#39;block&#39;;
// ä¸ºè¡¨å•å¡«å€¼
document.getElementById(&#39;userName&#39;).value = &#39;admin&#39;;
document.getElementById(&#39;passWord&#39;).value = &#39;123456&#39;;

// contentScriptZhihu.js
// å®æˆ˜: å»é™¤çŸ¥ä¹çš„ä¾§è¾¹æ ï¼Œè®©é¡µé¢æ›´è½»çˆ½
const globalSideBar = document.getElementsByClassName(&#39;GlobalSideBar&#39;)[0];
globalSideBar.parentElement.removeChild(globalSideBar);
document.getElementsByClassName(&#39;Topstory-container&#39;)[0].style.width = &#39;694px&#39;;
</code></pre>
<p>content script ä¸ chrome.scripting.executeScript çš„å›è°ƒä¹Ÿæœ‰å±€é™æ€§ï¼Œæ— æ³•ç›´æ¥è°ƒç”¨ç½‘é¡µä¸­çš„ jsã€‚</p>
<pre><code class="lang-js">const loginBtn = document.getElementsByClassName(&#39;login-btn&#39;);
loginBtn[0].click(); // æˆ–è€… window.goLogin();
// æŠ¥é”™ä¿¡æ¯: script.js:8 Refused to run the JavaScript URL because it violates the following Content Security Policy directive: &quot;script-src &#39;self&#39;&quot;
// æ‹’ç»æ‰§è¡Œ JavaScript URLï¼Œå› ä¸ºè¿åäº†å†…å®¹å®‰å…¨æ”¿ç­–æŒ‡ä»¤: &quot;script-src &#39;self&#39;&quot;
// æ³¨: ä¸ºäº†æ–¹ä¾¿éªŒè¯ï¼Œæˆ‘ä»¬ç›´æ¥å°†æ–¹æ³• goLogin æŒ‚åœ¨ window ä¸‹åšå…¨å±€æ–¹æ³•
</code></pre>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå‘ï¼Œæˆ‘ä»¬ç”¨è„šæœ¬ç›´æ¥ç»™ dom èµ‹å€¼æœ‰ä¸€äº›ä¾èµ–äº‹ä»¶çš„å‡½æ•°æ˜¯ä¸ä¼šè¢«è§¦å‘çš„ï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬åé¢ä¼šä»‹ç» <code>chrome.debugger.sendCommand</code> ç›¸å…³å†…å®¹ã€‚</p>
<p>æ— æ³•ä½¿ç”¨ <code>chrome.storage</code>ã€<code>chrome.action</code>ã€<code>chrome.tabs</code>ã€<code>chrome.debugger</code> ç­‰ï¼Œè¿™äº›æ˜¯ä»€ä¹ˆåé¢ä¼šè®²åˆ°ã€‚</p>
<p>ä½†æ˜¯ï¼Œåªè¦ä¸åœ¨ <code>executeScript</code> çš„å›è°ƒå‡½æ•°ä¸­ï¼Œpopup.js ä¸­æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å¯¹è±¡çš„ã€‚</p>
<h2 id="header-1-3">å·¥å…·åº“</h2>
<p>ä¸Šé¢æåˆ°äº†å¾ˆå¤šå·¥å…·åº“ï¼Œä¸‹é¢ç®€å•ä»‹ç»ä¸€äº›å¸¸ç”¨çš„å·¥å…·ã€‚</p>
<h3 id="header-1-3-1">chrome.storage</h3>
<p>åœ¨æœ€å¼€å§‹çš„ popup â€œåŸºæœ¬æµç¨‹â€ ä¸­å·²ç»å±•ç¤ºè¿‡ç”¨æ³•:</p>
<pre><code class="lang-js">// éªŒè¯æ¯æ¬¡æ‰“å¼€ popup é¡µé¢éƒ½æ˜¯é‡æ–°åŠ è½½çš„
chrome.storage.sync.get(&#39;total&#39;, ({
    total
}) =&gt; {
    total++;
    document.getElementById(&#39;total&#39;).innerHTML = total.toString();
    chrome.storage.sync.set({
        total
    });
});
</code></pre>
<p>åˆ©ç”¨å­˜å‚¨çš„æ•°æ®æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å°çª—ä¸­æ·»åŠ åˆ—è¡¨å’Œå…¶ä»– Dom å…ƒç´ ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªåˆå§‹åŒ–ä»»åŠ¡åˆ—è¡¨çš„ç¤ºä¾‹ä»£ç :</p>
<pre><code class="lang-js">// ä» storage ä¸­æ‹‰å–ä»»åŠ¡
chrome.storage.sync.get(&#39;taskList&#39;, ({
    taskList
}) =&gt; {
    let result = &#39;&#39;;
    if (taskList) {
        taskList.forEach(item =&gt; {
            result += `
            &lt;div class=&quot;item&quot;&gt;
                ${item.companyName}
                &lt;span class=&quot;${item.styleClass}&quot;&gt;
                    ${item.status}
                &lt;/span&gt;
            &lt;/div&gt;`;
        });
        const container = document.getElementById(&#39;task-container&#39;);
        container.innerHTML = result;
    }
});
</code></pre>
<p>set ç¤ºä¾‹ä»£ç :</p>
<pre><code class="lang-js">chrome.storage.sync.set({
    taskData: data
}, () =&gt; {
    // ...
});
</code></pre>
<p>è¿™ä¸ªæ–¹æ³•å¯ä»¥åšæ•°æ®æŒä¹…åŒ–ï¼Œæ›´å¤š API ä¼ é€é—¨: <a href="https://developer.chrome.com/docs/extensions/reference/storage/ã€‚" target="_blank">https://developer.chrome.com/docs/extensions/reference/storage/ã€‚</a></p>
<h3 id="header-1-3-2">chrome.action</h3>
<p>chrome.action æœ‰ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–¹æ³•æ˜¯ <code>setBadgeText</code>ã€‚</p>
<pre><code class="lang-js">chrome.action.setBadgeText({
    text: request.data.length.toString()
});
</code></pre>
<p><code>setBadgeText</code> æ–¹æ³•å¯ä»¥åœ¨ chrome extension å›¾æ ‡çš„å³ä¸‹è§’ç»™ä¸€ä¸ªæ–‡æœ¬ï¼Œè¿™åœ¨åšè‡ªåŠ¨åŒ–çš„æ’ä»¶ä¸­æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå¯ä»¥ç”¨ä½œè¿›åº¦æ ‡å¿—å’Œè®¡æ•°å™¨ã€‚</p>
<p>action å¯ä»¥æ“çºµå›¾æ ‡ï¼Œå€ŸåŠ© canvas ç”šè‡³å¯ä»¥åšåŠ¨ç”»ï¼Œå¯ä»¥ä¿®æ”¹ hover æ—¶çš„ titleï¼Œæ›´å¤š API ä¼ é€é—¨: <a href="https://developer.chrome.com/docs/extensions/reference/action/" target="_blank">https://developer.chrome.com/docs/extensions/reference/action/</a></p>
<h3 id="header-1-3-3">chrome.tabs</h3>
<p>ä¸Šé¢æåˆ°è¿‡ç”¨æ¥è·å–å½“å‰æ¿€æ´»çš„ tab:</p>
<pre><code class="lang-js">let [tab] = await chrome.tabs.query({
    active: true,
    currentWindow: true
});
</code></pre>
<p>è¿˜æœ‰ä¸€ä¸ªé‡è¦åŠŸèƒ½å°±æ˜¯æ‰“å¼€æ–° tab:</p>
<pre><code class="lang-js">chrome.tabs.create({
    url: &#39;https://etax.sichuan.chinatax.gov.cn&#39;,
    active: true
});
</code></pre>
<h3 id="header-1-3-4">chrome.windows</h3>
<p>å¦‚æœä½ å¼€ tab ä¸æ»¡æ„ï¼Œè¿˜å¯ä»¥å¼€æ–°æµè§ˆå™¨çª—å£:</p>
<pre><code class="lang-js">chrome.windows.create(
    {
        url: &#39;http://zhihu.com&#39;,
        height: 300,
        width: 400
    }
);
</code></pre>
<h3 id="header-1-3-5">chrome.debugger</h3>
<pre><code class="lang-js">chrome.debugger.sendCommand(target, &quot;Input.insertText&quot;, {
    text: value
}, function (){
    debugger
});
// æŠ¥é”™ä¿¡æ¯: Unchecked runtime.lastError: Either tab id or extension id must be specified.
// æŠ¥é”™ä¿¡æ¯: Debugger is not attached
// æŠ¥é”™ä¿¡æ¯: Error handling response: TypeError: Error in invocation of debugger.attach(debugger.Debuggee target, string requiredVersion, optional function callback): No matching signature.
// å‚è€ƒ:
// https://chromedevtools.github.io/devtools-protocol/tot/Input/#method-insertText
// https://www.jianshu.com/p/6422a1c4b6f2
</code></pre>
<p>å¦‚æœä¸Šé¢å·¥å…·ä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œæˆ–è€…ä½ æƒ³æ¢ç´¢æ›´å¤šçš„åŠŸèƒ½ç‰¹æ€§ï¼Œè¯·è¿›å…¥æ›´å¤šå·¥å…·ä¼ é€é—¨: <a href="https://developer.chrome.com/docs/extensions/reference/" target="_blank">https://developer.chrome.com/docs/extensions/reference/</a></p>
<h2 id="header-1-4">background</h2>
<p>popup ä¸ content script æ˜¯éšç€ tab çš„åˆ‡æ¢è€Œåˆ‡æ¢çš„ï¼Œåªæœ‰ background æ‰æ˜¯é•¿ä¹…é©»ç•™æµè§ˆå™¨çš„è¿›ç¨‹ï¼Œä¸åŒ tab ä¹‹é—´çš„äº¤äº’éœ€è¦ä¾èµ– backgroundã€‚</p>
<pre><code class="lang-json">{
    &quot;background&quot;: {
        &quot;service_worker&quot;: &quot;background.js&quot;
    }
}
</code></pre>
<p>è¿™åœ¨é€šä¿¡ä¸­éå¸¸æœ‰ç”¨ï¼Œå¦‚æœ popup ä¸æ˜¯åœ¨æ‰“å¼€çŠ¶æ€ä¸‹ï¼Œé‚£ä¹ˆ content script æ˜¯é€šçŸ¥ä¸åˆ° popup çš„ã€‚å¹¶ä¸”ï¼Œå¦‚æœ content script å·²ç»å‘å‡ºäº†é€šçŸ¥ï¼Œä½†æ˜¯ popup æ²¡æ‰“å¼€ï¼Œé‚£ä¹ˆ popup ä¸­çš„æ¶ˆæ¯ç›‘å¬å°†ä¼šè¢«é”™è¿‡ã€‚background å¯ä»¥å¾ˆå¥½çš„å¼¥è¡¥è¿™ä¸€ç¼ºé™·ï¼Œæ¥åšä¸€äº›å¸¸é©»çš„åŠŸèƒ½ã€‚</p>
<h2 id="header-1-5">é€šä¿¡</h2>
<p>é¦–å…ˆä¸Šä¸€å¼ å›¾ï¼Œå¯¹äºæ¶ˆæ¯è¿™æ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªå›¾:</p>
<p><img src="./img/8.png" alt="æ¶ˆæ¯ä¼ é€’å›¾"></p>
<p>å‘é€æ¶ˆæ¯:</p>
<pre><code class="lang-js">chrome.runtime.sendMessage({
    name: &#39;aaa&#39;,
    data: {
        num: 123,
        str: &#39;å­—ç¬¦ä¸²&#39;,
        obj: {},
        arr: []
    }
});
</code></pre>
<p>ç»“æŸæ¶ˆæ¯:</p>
<pre><code class="lang-js">chrome.runtime.onMessage.addListener(request =&gt; {
    if (request.name === &#39;aaa&#39;) {
        chrome.action.setBadgeText({
            text: &#39;ğŸ‘‚&#39;
        });
    }
});
</code></pre>
<h2 id="header-1-6">æ¨¡æ‹Ÿäº‹ä»¶</h2>
<p>background.js ä¸­æ¥æ”¶æ¶ˆæ¯</p>
<pre><code class="lang-js">chrome.runtime.onMessage.addListener((request, sender) =&gt; {});
</code></pre>
<p>attachï¼Œåœ¨è¿›å…¥æ¨¡æ‹Ÿå‰è¦ attachï¼Œå¦åˆ™æ¨¡æ‹Ÿä¼šæŠ¥é”™ã€‚</p>
<pre><code class="lang-js">chrome.debugger.attach({
    extensionId: chrome.runtime.id,
    tabId: sender.tab.id
}, &#39;1.3&#39;, () =&gt; {
    if (chrome.runtime.lastError) {
        // oh no!
    }
    else {
        // ...
    }
});
</code></pre>
<p>æ¨¡æ‹Ÿè¾“å…¥ï¼Œå‚æ•°æ–‡æ¡£: <a href="https://chromedevtools.github.io/devtools-protocol/tot/Input/#method-insertText" target="_blank">https://chromedevtools.github.io/devtools-protocol/tot/Input/#method-insertText</a></p>
<pre><code class="lang-js">chrome.debugger.sendCommand({
    extensionId: chrome.runtime.id,
    tabId: sender.tab.id,
    x: 2,
    y: 2
}, &quot;Input.insertText&quot;, {
    text: &#39;456&#39;
}, () =&gt; {

});
</code></pre>
<h2 id="header-1-7">è·¨åŸŸè¯·æ±‚æ•°æ®</h2>
<p>è·¨åŸŸè¯·æ±‚æ•°æ®çš„æ—¶å€™ä¼šé‡åˆ°è·¨åŸŸé—®é¢˜ï¼Œåœ¨é…ç½®ä¸­æ·»åŠ  <code>host_permissions</code> é…ç½®:</p>
<pre><code class="lang-json">{
    &quot;host_permissions&quot;: [
        &quot;http://127.0.0.1:4000&quot;
    ]
}
</code></pre>
<h2 id="header-1-8">å¤‡å¿˜</h2>

</div>
</body>
</html>